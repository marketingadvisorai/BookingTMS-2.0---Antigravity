# BookingTMS System Architecture

> **Version**: 0.1.7  
> **Last Updated**: November 25, 2025

---

## Table of Contents
1. [System Overview](#system-overview)
2. [Entity Hierarchy](#entity-hierarchy)
3. [Database Schema](#database-schema)
4. [Widget System](#widget-system)
5. [Booking Flow](#booking-flow)
6. [Embed System](#embed-system)
7. [Time Slot Generation](#time-slot-generation)
8. [User Roles & Permissions](#user-roles--permissions)
9. [Key Services](#key-services)
10. [File Structure](#file-structure)

---

## System Overview

BookingTMS is a multi-tenant booking management system designed for experience-based businesses like escape rooms, rage rooms, and similar venues.

### Core Concept
```
Organization (Tenant) → Venue(s) → Activity(ies) → Time Slots → Bookings
```

### Key Features
- Multi-organization support (SaaS model)
- Multiple venues per organization
- Multiple activities per venue
- Automatic time slot generation
- Embeddable booking widgets
- Stripe payment integration
- Real-time availability

---

## Entity Hierarchy

```
┌─────────────────────────────────────────────────────────────────┐
│                        ORGANIZATION                              │
│  (Top-level tenant account - escape room business)               │
│                                                                   │
│  Fields: id, name, owner_email, plan_id, stripe_account_id       │
│  Managed by: System Admin, Super Admin                           │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                           VENUE                                   │
│  (Physical location - "Downtown Escape Room")                     │
│                                                                   │
│  Fields: id, organization_id, name, address, embed_key, settings │
│  Managed by: Org Admin, Super Admin, System Admin                │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                          ACTIVITY                                 │
│  (Bookable experience - "Zombie Apocalypse Room")                │
│                                                                   │
│  Fields: id, venue_id, organization_id, name, schedule, price    │
│  Managed by: Org Admin, Venue Manager, System Admin              │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      ACTIVITY_SESSIONS                            │
│  (Time slots - auto-generated from schedule)                      │
│                                                                   │
│  Fields: id, activity_id, start_time, end_time, capacity         │
│  Generated by: SessionService (automatic)                         │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                          BOOKINGS                                 │
│  (Customer reservations)                                          │
│                                                                   │
│  Fields: id, session_id, activity_id, customer_id, status        │
│  Created by: Customer via Widget, Staff via Admin                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Database Schema

### Organizations Table
```sql
organizations (
  id UUID PRIMARY KEY,
  name TEXT NOT NULL,
  owner_name TEXT,
  owner_email TEXT,
  plan_id UUID REFERENCES plans(id),
  stripe_account_id TEXT,
  stripe_charges_enabled BOOLEAN,
  stripe_payouts_enabled BOOLEAN,
  application_fee_percentage DECIMAL,
  status TEXT DEFAULT 'pending',
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
)
```

### Venues Table
```sql
venues (
  id UUID PRIMARY KEY,
  organization_id UUID REFERENCES organizations(id),
  name TEXT NOT NULL,
  address TEXT,
  city TEXT,
  state TEXT,
  zip TEXT,
  country TEXT,
  phone TEXT,
  email TEXT,
  timezone TEXT DEFAULT 'America/New_York',
  embed_key TEXT UNIQUE, -- Auto-generated for embedding
  primary_color TEXT DEFAULT '#2563eb',
  settings JSONB,
  status TEXT DEFAULT 'active',
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
)
```

### Activities Table
```sql
activities (
  id UUID PRIMARY KEY,
  venue_id UUID REFERENCES venues(id),
  organization_id UUID REFERENCES organizations(id),
  name TEXT NOT NULL,
  description TEXT,
  tagline TEXT,
  category TEXT,
  activity_type TEXT, -- 'physical', 'virtual', 'hybrid'
  event_type TEXT, -- 'public', 'private'
  duration INTEGER, -- minutes
  capacity INTEGER,
  price DECIMAL,
  schedule JSONB, -- Schedule configuration
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
)
```

### Activity Sessions Table
```sql
activity_sessions (
  id UUID PRIMARY KEY,
  activity_id UUID REFERENCES activities(id),
  venue_id UUID REFERENCES venues(id),
  organization_id UUID REFERENCES organizations(id),
  start_time TIMESTAMPTZ NOT NULL,
  end_time TIMESTAMPTZ NOT NULL,
  capacity_total INTEGER,
  capacity_remaining INTEGER,
  price_at_generation DECIMAL,
  is_closed BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ
)
```

### Bookings Table
```sql
bookings (
  id UUID PRIMARY KEY,
  session_id UUID REFERENCES activity_sessions(id),
  activity_id UUID REFERENCES activities(id),
  venue_id UUID REFERENCES venues(id),
  organization_id UUID REFERENCES organizations(id),
  customer_id UUID REFERENCES customers(id),
  guest_count INTEGER,
  total_amount DECIMAL,
  status TEXT DEFAULT 'pending',
  payment_status TEXT,
  stripe_payment_intent_id TEXT,
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
)
```

---

## Widget System

### Widget Types

| Widget Type | Component | Purpose | URL Parameter |
|------------|-----------|---------|---------------|
| **Venue Calendar** | `CalendarWidget` | Shows ALL activities in a venue | `widget=calendar` |
| **Activity Booking** | `CalendarSingleEventBookingPage` | Books a SINGLE activity | `widget=singlegame` or `widget=booking` |

### Widget Flow

```
┌──────────────────────────────────────────────────────────────────┐
│                      VENUE WIDGET (Full Calendar)                 │
│                                                                   │
│  URL: /embed?widget=calendar&key={venue_embed_key}               │
│  Component: CalendarWidget                                        │
│                                                                   │
│  Features:                                                        │
│  - Lists all activities in the venue                             │
│  - Customer selects activity → date → time slot                  │
│  - Shows availability across all activities                       │
└──────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│                    ACTIVITY WIDGET (Single Calendar)              │
│                                                                   │
│  URL: /embed?widget=singlegame&key={venue_embed_key}             │
│       &activityId={activity_id}                                   │
│  Component: CalendarSingleEventBookingPage                        │
│                                                                   │
│  Features:                                                        │
│  - Focused on single activity                                     │
│  - Customer selects date → time slot → checkout                  │
│  - Optimized conversion flow                                      │
└──────────────────────────────────────────────────────────────────┘
```

### Widget Configuration

Widgets are configured through:
1. **Venue Settings** (`venues.settings.widgetConfig`)
2. **Activity Wizard Step 7** (`Step7WidgetEmbedNew.tsx`)

Configuration options include:
- Primary color
- Theme (light/dark)
- Business information
- Categories
- Games/Activities list
- Additional questions
- Cancellation policy

---

## Booking Flow

### Customer Booking Journey

```
1. Customer visits embedded widget or booking page
                    │
                    ▼
2. Widget loads venue config via embedKey
   └─ SupabaseBookingService.getVenueWidgetConfig()
                    │
                    ▼
3. Customer selects Activity (if venue widget)
   └─ Or pre-selected (if activity widget)
                    │
                    ▼
4. Customer selects Date on calendar
   └─ Shows available dates based on schedule
                    │
                    ▼
5. Customer selects Time Slot
   └─ Lists available sessions from activity_sessions
                    │
                    ▼
6. Customer enters details & proceeds to checkout
   └─ Guest count, contact info, additional questions
                    │
                    ▼
7. Payment via Stripe Checkout
   └─ CheckoutService.createBookingWithCheckout()
                    │
                    ▼
8. Booking confirmed
   └─ Session capacity decremented
   └─ Confirmation email sent
```

### Key Services

| Service | Location | Purpose |
|---------|----------|---------|
| `SupabaseBookingService` | `/src/services/SupabaseBookingService.ts` | Widget data loading, public booking |
| `BookingService` | `/src/lib/bookings/bookingService.ts` | Admin booking operations |
| `CheckoutService` | `/src/lib/payments/checkoutService.ts` | Stripe checkout integration |
| `SessionService` | `/src/services/session.service.ts` | Time slot generation |
| `ActivityService` | `/src/modules/inventory/services/activity.service.ts` | Activity CRUD |

---

## Embed System

### Generating Embed Codes

**For Venues** (from `Venues.tsx`):
```javascript
// Venue embed uses widget=calendar
const embedUrl = `${baseUrl}/embed?widget=calendar&key=${venue.embedKey}`;
```

**For Activities** (from `Step7WidgetEmbedNew.tsx`):
```javascript
// Activity embed uses widget=singlegame
const embedUrl = `${baseUrl}/embed?widget=singlegame&key=${venue.embedKey}&activityId=${activityId}`;
```

### Embed Flow

```
1. External website loads iframe with embed URL
                    │
                    ▼
2. Embed.tsx parses URL parameters
   └─ widget, key, color, theme, mode
                    │
                    ▼
3. Fetches venue config from Supabase
   └─ Uses embedKey to find venue
   └─ Loads activities for that venue
                    │
                    ▼
4. Renders appropriate widget component
   └─ CalendarWidget or CalendarSingleEventBookingPage
                    │
                    ▼
5. Widget communicates with parent via postMessage
   └─ Resize events
   └─ Booking completion
```

---

## Time Slot Generation

### Schedule Configuration (Step 5)

Activities have a `schedule` JSONB field containing:
```typescript
interface ActivityScheduleRules {
  operatingDays: string[];     // ['Monday', 'Tuesday', ...]
  startTime: string;           // '09:00'
  endTime: string;             // '22:00'
  slotInterval: number;        // 60 (minutes)
  customHours?: Record<string, { enabled: boolean; startTime: string; endTime: string }>;
  customDates?: Array<{ date: string; startTime: string; endTime: string }>;
}
```

### Session Generation Process

```
SessionService.generateSessions(activityId, daysToGenerate)
                    │
                    ▼
1. Fetch activity and venue (for timezone)
                    │
                    ▼
2. Loop through each day (default 90 days ahead)
                    │
                    ▼
3. Check if day is in operatingDays
                    │
                    ▼
4. Generate slots from startTime to endTime
   └─ Using slotInterval (e.g., every 60 minutes)
                    │
                    ▼
5. Convert venue local time to UTC
                    │
                    ▼
6. Insert sessions into activity_sessions table
   └─ capacity_total = activity.capacity
   └─ capacity_remaining = activity.capacity
```

### When Sessions Are Generated

- **Manual**: Via "Generate Slots" action (to be implemented)
- **Automatic**: After activity is published (to be implemented)
- **Rolling**: Cron job to extend into future (recommended for production)

---

## User Roles & Permissions

| Role | Scope | Can Manage |
|------|-------|------------|
| `system-admin` | Platform-wide | All orgs, venues, activities |
| `super-admin` | Organization | Own org's venues, activities |
| `org-admin` | Organization | Own org's venues, activities |
| `admin` | Organization | Venues, activities, bookings |
| `manager` | Venue | Activities, bookings |
| `staff` | Venue | View bookings, check-in |
| `customer` | N/A | Own bookings only |

### Permission Checks

```typescript
// In components
const { hasPermission, isRole } = useAuth();

// Check specific permission
if (hasPermission('activities.create')) { ... }

// Check role
if (isRole('system-admin')) { ... }
```

---

## Key Services

### ActivityService
**Location**: `/src/modules/inventory/services/activity.service.ts`

| Method | Purpose |
|--------|---------|
| `createActivity()` | Create new activity |
| `updateActivity()` | Update existing activity |
| `deleteActivity()` | Delete activity |
| `getActivity()` | Get single activity |
| `listActivities()` | List activities for venue |

### SessionService
**Location**: `/src/services/session.service.ts`

| Method | Purpose |
|--------|---------|
| `generateSessions()` | Create time slots for activity |
| `listAvailableSessions()` | Get bookable sessions |
| `getSessionByTime()` | Find specific session |

### SupabaseBookingService
**Location**: `/src/services/SupabaseBookingService.ts`

| Method | Purpose |
|--------|---------|
| `getVenueByEmbedKey()` | Fetch venue for widget |
| `getVenueActivities()` | Fetch activities for venue |
| `getVenueWidgetConfig()` | Get complete widget config |
| `createWidgetBooking()` | Create booking from widget |

---

## File Structure

```
src/
├── components/
│   ├── events/
│   │   ├── steps/
│   │   │   ├── Step1BasicInfo.tsx      # Name, org, venue selection
│   │   │   ├── Step2CapacityPricing.tsx # Capacity, pricing tiers
│   │   │   ├── Step3ActivityDetails.tsx # Duration, difficulty
│   │   │   ├── Step4MediaUpload.tsx     # Images
│   │   │   ├── Step5Schedule.tsx        # Operating days, hours
│   │   │   ├── Step6PaymentSettings.tsx # Stripe config
│   │   │   ├── Step7WidgetEmbedNew.tsx  # Embed code generation
│   │   │   └── Step8Review.tsx          # Final review
│   │   └── AddServiceItemWizard.tsx     # Main wizard container
│   │
│   ├── widgets/
│   │   ├── CalendarWidget.tsx           # Venue full calendar
│   │   ├── CalendarSingleEventBookingPage.tsx # Activity booking
│   │   └── EmbedPreview.tsx             # Embed code preview
│   │
│   └── organizations/
│       └── OrganizationSettingsModal.tsx
│
├── pages/
│   ├── Organizations.tsx    # Org management (System Admin)
│   ├── Venues.tsx          # Venue management
│   ├── Events.tsx          # Activity management
│   ├── Embed.tsx           # Widget rendering endpoint
│   └── Bookings.tsx        # Booking management
│
├── services/
│   ├── session.service.ts          # Time slot generation
│   └── SupabaseBookingService.ts   # Widget booking operations
│
├── modules/
│   └── inventory/
│       └── services/
│           └── activity.service.ts  # Activity CRUD
│
└── lib/
    ├── bookings/
    │   └── bookingService.ts        # Admin booking operations
    ├── payments/
    │   └── checkoutService.ts       # Stripe checkout
    └── embed/
        └── EmbedManager.ts          # Embed code generation
```

---

## Real-Time Widget System

### Overview
The booking widgets use Supabase Real-time to provide instant updates across all users.

### Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      ADMIN UPDATES FLOW                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   Admin Dashboard                                                │
│        │                                                         │
│        ▼                                                         │
│   ActivityService.updateActivity()                               │
│        │                                                         │
│        ├─→ Updates `activities` table                            │
│        │                                                         │
│        └─→ SessionService.generateSessions()                     │
│                   │                                              │
│                   ▼                                              │
│            Updates `activity_sessions` table                     │
│                   │                                              │
│                   ▼                                              │
│            Supabase broadcasts UPDATE event                      │
│                   │                                              │
│                   ▼                                              │
│            useWidgetData receives event                          │
│                   │                                              │
│                   ▼                                              │
│            Widget re-renders with new data                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      BOOKING FLOW                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   Customer selects time slot                                     │
│        │                                                         │
│        ▼                                                         │
│   CheckoutService.createBookingWithCheckout()                    │
│        │                                                         │
│        ├─→ Creates booking record                                │
│        │                                                         │
│        └─→ updateSessionCapacity()                               │
│                   │                                              │
│                   ▼                                              │
│            capacity_remaining decremented                        │
│                   │                                              │
│                   ▼                                              │
│            Supabase broadcasts UPDATE event                      │
│                   │                                              │
│                   ▼                                              │
│            Other widgets see slot unavailable                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Key Components

| Component | Location | Purpose |
|-----------|----------|---------|
| `useWidgetData` | `/src/hooks/useWidgetData.ts` | Fetches + subscribes to real-time updates |
| `CheckoutService` | `/src/lib/payments/checkoutService.ts` | Handles bookings + capacity updates |
| `Embed.tsx` | `/src/pages/Embed.tsx` | Widget container with real-time subscriptions |
| `SupabaseBookingService` | `/src/services/SupabaseBookingService.ts` | Widget data loading |

### Real-Time Subscriptions

```typescript
// useWidgetData subscribes to:
supabase.channel(`activities-venue-${venueId}`)
  .on('postgres_changes', { table: 'activities', filter: `venue_id=eq.${venueId}` })

supabase.channel(`sessions-activity-${activityId}`)  
  .on('postgres_changes', { table: 'activity_sessions', filter: `activity_id=eq.${activityId}` })
```

### Embed URL Format
```
/embed?widget=calendar&key={venue_embed_key}&color={hex_color}&theme={light|dark}
```

### What Updates in Real-Time
- **Price changes**: Immediate reflection in widget
- **Schedule changes**: Sessions regenerated, widget updates
- **Blocked dates**: Sessions marked unavailable
- **Bookings**: Capacity decrements, availability updates

---

## Router Architecture

### Route Priority
Routes are defined in `/src/router.tsx`. Order matters!

```
1. Explicit admin routes (e.g., /dashboard, /organizations)
2. /:slug - Public venue profile pages
3. /* - 404 catch-all
```

### Important Routes

| Route | Component | Purpose |
|-------|-----------|---------|
| `/dashboard` | Dashboard | Main admin dashboard |
| `/organizations` | Organizations | Manage all organizations |
| `/venues` | Venues | Venue management |
| `/events` | Events | Activity management |
| `/system-admin` | SystemAdminDashboard | Platform-level admin |
| `/:slug` | VenueProfile | Public venue page |
| `/embed?widget=...` | Embed | Widget rendering |

### Adding New Routes
**IMPORTANT**: All admin routes must be explicitly defined BEFORE the `/:slug` catch-all route in `router.tsx`.

---

## Next Steps

1. **Session Auto-Generation**: Trigger session generation when activity is published
2. **Activity Embed Keys**: Add dedicated embedKey for activities (optional)
3. **Real-time Availability**: Ensure sessions update in real-time
4. **Production Cron**: Set up rolling session generation

---

*Document maintained by the development team. Last reviewed: November 2025.*
