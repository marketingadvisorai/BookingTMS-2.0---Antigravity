# System Admin Architecture & Implementation Plan

**Version:** 1.0  
**Date:** November 17, 2025  
**Status:** Implementation Ready

---

## ğŸ¯ Objectives

1. **Auto-generate Organization IDs** using Supabase UUID
2. **Real Venue & Game IDs** from database with proper foreign key relationships
3. **Venue/Game fields remain empty** when creating organizations (no validation errors)
4. **Automatic syncing** of Venue IDs and Game IDs to System Admin dashboard
5. **Stripe integration** for organization billing
6. **Feature flags** populated with admin access items
7. **Industry-standard architecture** following multi-tenant SaaS best practices

---

## ğŸ“Š Current Database Schema

### Core Tables Hierarchy

```
organizations (Parent)
    â”œâ”€â”€ UUID id (Primary Key, Auto-generated)
    â”œâ”€â”€ name
    â”œâ”€â”€ owner_name
    â”œâ”€â”€ owner_email
    â”œâ”€â”€ plan_id â†’ plans(id)
    â”œâ”€â”€ stripe_customer_id
    â”œâ”€â”€ status
    â””â”€â”€ created_at
    
    â†“ (One-to-Many)
    
venues (Child of Organization)
    â”œâ”€â”€ UUID id (Primary Key, Auto-generated)
    â”œâ”€â”€ organization_id â†’ organizations(id) FK
    â”œâ”€â”€ name
    â”œâ”€â”€ address
    â”œâ”€â”€ status
    â””â”€â”€ created_at
    
    â†“ (One-to-Many)
    
games (Child of Venue)
    â”œâ”€â”€ UUID id (Primary Key, Auto-generated)
    â”œâ”€â”€ venue_id â†’ venues(id) FK
    â”œâ”€â”€ organization_id â†’ organizations(id) FK
    â”œâ”€â”€ name
    â”œâ”€â”€ difficulty
    â”œâ”€â”€ price
    â”œâ”€â”€ stripe_product_id
    â”œâ”€â”€ stripe_price_id
    â””â”€â”€ created_at
    
    â†“ (One-to-Many)
    
bookings (Child of Game)
    â”œâ”€â”€ UUID id (Primary Key, Auto-generated)
    â”œâ”€â”€ game_id â†’ games(id) FK
    â”œâ”€â”€ venue_id â†’ venues(id) FK
    â”œâ”€â”€ organization_id â†’ organizations(id) FK
    â”œâ”€â”€ customer_email
    â”œâ”€â”€ stripe_payment_intent_id
    â””â”€â”€ created_at
```

### Supporting Tables

```
plans
    â”œâ”€â”€ UUID id (Primary Key)
    â”œâ”€â”€ name (Free, Basic, Pro, Enterprise)
    â”œâ”€â”€ stripe_product_id
    â”œâ”€â”€ stripe_price_id
    â”œâ”€â”€ features JSONB
    â””â”€â”€ price

organization_members
    â”œâ”€â”€ UUID id (Primary Key)
    â”œâ”€â”€ organization_id â†’ organizations(id) FK
    â”œâ”€â”€ user_id â†’ auth.users(id) FK
    â”œâ”€â”€ role (owner, admin, member)
    â””â”€â”€ permissions JSONB

feature_flags
    â”œâ”€â”€ UUID id (Primary Key)
    â”œâ”€â”€ name
    â”œâ”€â”€ key
    â”œâ”€â”€ enabled
    â”œâ”€â”€ available_for_roles JSONB
    â””â”€â”€ metadata JSONB
```

---

## ğŸ—ï¸ Implementation Architecture

### 1. Organization Creation Flow

#### Step 1: User Submits Form
```typescript
// src/features/system-admin/components/organizations/OrganizationModal.tsx
interface CreateOrganizationDTO {
  name: string;                    // Required
  owner_name: string;              // Required
  owner_email: string;             // Required
  plan_id: string;                 // Required
  status: 'pending' | 'active';    // Required
  // âŒ NO venue_ids or game_ids fields
}
```

#### Step 2: Backend Processing
```typescript
// src/features/system-admin/services/OrganizationService.ts
static async create(data: CreateOrganizationDTO): Promise<Organization> {
  // 1. Create organization with auto-generated UUID
  const { data: org, error } = await supabase
    .from('organizations')
    .insert({
      // UUID auto-generated by PostgreSQL DEFAULT uuid_generate_v4()
      name: data.name,
      owner_name: data.owner_name,
      owner_email: data.owner_email,
      plan_id: data.plan_id,
      status: data.status,
      created_at: new Date().toISOString(),
    })
    .select('*')
    .single();
  
  if (error) throw error;
  
  // 2. Create Stripe customer
  const stripeCustomer = await createStripeCustomer({
    email: data.owner_email,
    name: data.owner_name,
    metadata: {
      organization_id: org.id,
      organization_name: data.name,
    },
  });
  
  // 3. Update organization with Stripe ID
  await supabase
    .from('organizations')
    .update({ stripe_customer_id: stripeCustomer.id })
    .eq('id', org.id);
  
  // 4. Create initial owner member
  await supabase
    .from('organization_members')
    .insert({
      organization_id: org.id,
      user_id: getCurrentUserId(),
      role: 'owner',
      permissions: { all: true },
    });
  
  return { ...org, stripe_customer_id: stripeCustomer.id };
}
```

#### Step 3: Database Triggers (Auto-sync)
```sql
-- Trigger to update organization metrics when venues are created/deleted
CREATE OR REPLACE FUNCTION update_organization_venue_count()
RETURNS TRIGGER AS $$
BEGIN
  -- Automatically update organization stats
  PERFORM update_organization_metrics(
    CASE 
      WHEN TG_OP = 'DELETE' THEN OLD.organization_id
      ELSE NEW.organization_id
    END
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER organization_venue_sync
AFTER INSERT OR UPDATE OR DELETE ON venues
FOR EACH ROW
EXECUTE FUNCTION update_organization_venue_count();
```

---

### 2. Venue Creation Flow

#### Form Design
```typescript
// src/components/venues/VenueForm.tsx
interface CreateVenueDTO {
  organization_id: string;  // Auto-populated from current org context
  name: string;
  address: string;
  email?: string;
  phone?: string;
  status: 'active' | 'inactive';
  // âŒ NO venue_id field (auto-generated)
  // âŒ NO game_ids field (populated later)
}
```

#### Backend Processing
```typescript
// src/services/VenueService.ts
static async create(data: CreateVenueDTO): Promise<Venue> {
  // 1. Create venue with auto-generated UUID
  const { data: venue, error } = await supabase
    .from('venues')
    .insert({
      // UUID auto-generated automatically
      organization_id: data.organization_id,
      name: data.name,
      address: data.address,
      email: data.email,
      phone: data.phone,
      status: data.status,
      created_at: new Date().toISOString(),
    })
    .select('*')
    .single();
  
  if (error) throw error;
  
  // 2. Trigger automatically updates organization metrics
  // 3. Real-time subscription broadcasts change to System Admin
  
  return venue;
}
```

#### Real-time Sync to System Admin
```typescript
// src/features/system-admin/hooks/useOrganizations.ts
export const useOrganizations = () => {
  const queryClient = useQueryClient();
  
  useEffect(() => {
    // Subscribe to real-time changes
    const subscription = supabase
      .channel('system_admin_organizations')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'venues',
        },
        (payload) => {
          // Invalidate and refetch organization data
          queryClient.invalidateQueries(['organizations']);
          queryClient.invalidateQueries(['platform-metrics']);
        }
      )
      .subscribe();
    
    return () => {
      subscription.unsubscribe();
    };
  }, [queryClient]);
  
  // ... rest of hook
};
```

---

### 3. Game Creation Flow

#### Form Design
```typescript
// src/components/games/GameForm.tsx
interface CreateGameDTO {
  venue_id: string;        // Selected from dropdown
  organization_id: string; // Auto-populated from venue
  name: string;
  difficulty: 'easy' | 'medium' | 'hard' | 'expert';
  duration: number;
  max_players: number;
  min_players: number;
  price: number;
  description?: string;
  // âŒ NO game_id field (auto-generated)
  // âŒ NO stripe_product_id initially (created on save)
}
```

#### Backend Processing with Stripe
```typescript
// src/services/GameService.ts
static async create(data: CreateGameDTO): Promise<Game> {
  // 1. Create Stripe Product
  const stripeProduct = await stripe.products.create({
    name: data.name,
    description: data.description,
    metadata: {
      venue_id: data.venue_id,
      organization_id: data.organization_id,
      difficulty: data.difficulty,
    },
  });
  
  // 2. Create Stripe Price
  const stripePrice = await stripe.prices.create({
    product: stripeProduct.id,
    unit_amount: Math.round(data.price * 100), // Convert to cents
    currency: 'usd',
    metadata: {
      game_name: data.name,
    },
  });
  
  // 3. Create game in Supabase
  const { data: game, error } = await supabase
    .from('games')
    .insert({
      // UUID auto-generated
      venue_id: data.venue_id,
      organization_id: data.organization_id,
      name: data.name,
      difficulty: data.difficulty,
      duration: data.duration,
      max_players: data.max_players,
      min_players: data.min_players,
      price: data.price,
      description: data.description,
      stripe_product_id: stripeProduct.id,
      stripe_price_id: stripePrice.id,
      status: 'active',
      created_at: new Date().toISOString(),
    })
    .select('*')
    .single();
  
  if (error) throw error;
  
  // 4. Triggers automatically update venue and org metrics
  
  return game;
}
```

---

### 4. System Admin Dashboard Sync

#### Real-time Data Aggregation
```typescript
// src/features/system-admin/hooks/useOrganizationMetrics.ts
export const useOrganizationMetrics = (orgId: string) => {
  const { data: metrics, isLoading } = useQuery({
    queryKey: ['organization-metrics', orgId],
    queryFn: async () => {
      // Calls Supabase RPC function
      const { data, error } = await supabase
        .rpc('get_organization_metrics', { org_id: orgId })
        .single();
      
      if (error) throw error;
      
      // Returns:
      return {
        total_venues: data.total_venues,        // Count from venues table
        active_venues: data.active_venues,      // WHERE status = 'active'
        total_games: data.total_games,          // Count from games table
        active_games: data.active_games,        // WHERE status = 'active'
        total_bookings: data.total_bookings,    // Count from bookings table
        total_revenue: data.total_revenue,      // SUM from bookings
        mrr: data.mrr,                          // Monthly recurring revenue
        venue_ids: data.venue_ids,              // ARRAY_AGG(id) from venues
        game_ids: data.game_ids,                // ARRAY_AGG(id) from games
      };
    },
    refetchInterval: 30000, // Refresh every 30 seconds
    staleTime: 10000,       // Consider stale after 10 seconds
  });
  
  return { metrics, isLoading };
};
```

#### Display in System Admin Table
```typescript
// src/pages/SystemAdminDashboard.tsx

// Real-time venue IDs display
{visibleColumns.venueIds && (
  <td className="py-5 px-6">
    <div className="flex flex-wrap gap-1 justify-center">
      {/* Fetch from useOrganizationMetrics */}
      {orgMetrics?.venue_ids?.slice(0, 3).map(venueId => (
        <code 
          key={venueId}
          className="text-xs font-mono px-2 py-0.5 rounded bg-blue-50 text-blue-700"
        >
          {venueId}
        </code>
      ))}
      {orgMetrics?.venue_ids?.length > 3 && (
        <span className="text-xs text-gray-500">
          +{orgMetrics.venue_ids.length - 3} more
        </span>
      )}
    </div>
  </td>
)}

// Real-time game IDs display
{visibleColumns.gameIds && (
  <td className="py-5 px-6">
    <div className="flex flex-wrap gap-1 justify-center">
      {orgMetrics?.game_ids?.slice(0, 3).map(gameId => (
        <code 
          key={gameId}
          className="text-xs font-mono px-2 py-0.5 rounded bg-green-50 text-green-700"
        >
          {gameId}
        </code>
      ))}
      {orgMetrics?.game_ids?.length > 3 && (
        <span className="text-xs text-gray-500">
          +{orgMetrics.game_ids.length - 3} more
        </span>
      )}
    </div>
  </td>
)}
```

---

## ğŸ¨ Feature Flags Implementation

### Database Schema
```sql
-- Feature flags table
CREATE TABLE IF NOT EXISTS feature_flags (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(255) NOT NULL UNIQUE,
  key VARCHAR(100) NOT NULL UNIQUE,
  description TEXT,
  enabled BOOLEAN DEFAULT false,
  available_for_roles JSONB DEFAULT '["admin", "owner"]'::JSONB,
  available_for_plans JSONB DEFAULT '["pro", "enterprise"]'::JSONB,
  metadata JSONB DEFAULT '{}'::JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Seed with admin access features (excluding backend)
INSERT INTO feature_flags (name, key, description, enabled, available_for_roles) VALUES
('Dashboard Analytics', 'dashboard_analytics', 'Access to advanced analytics dashboard', true, '["admin", "owner"]'),
('Venue Management', 'venue_management', 'Create and manage venues', true, '["admin", "owner"]'),
('Game Management', 'game_management', 'Create and manage games', true, '["admin", "owner"]'),
('Booking Management', 'booking_management', 'View and manage bookings', true, '["admin", "owner", "staff"]'),
('Customer Management', 'customer_management', 'Manage customer data and profiles', true, '["admin", "owner"]'),
('Payment Processing', 'payment_processing', 'Process payments and refunds', true, '["admin", "owner"]'),
('Reports', 'reports', 'Generate and view reports', true, '["admin", "owner"]'),
('Stripe Integration', 'stripe_integration', 'Manage Stripe settings', true, '["admin", "owner"]'),
('Email Templates', 'email_templates', 'Customize email templates', true, '["admin", "owner"]'),
('Waiver Management', 'waiver_management', 'Manage digital waivers', true, '["admin", "owner", "staff"]'),
('Calendar Management', 'calendar_management', 'Manage venue and game calendars', true, '["admin", "owner"]'),
('Widget Configuration', 'widget_configuration', 'Configure booking widgets', true, '["admin", "owner"]'),
('Team Management', 'team_management', 'Manage team members and roles', true, '["admin", "owner"]'),
('Pricing & Discounts', 'pricing_discounts', 'Manage pricing and discount codes', true, '["admin", "owner"]'),
('Account Settings', 'account_settings', 'Manage account settings', true, '["admin", "owner"]')
-- âŒ Backend access is NOT included
ON CONFLICT (key) DO NOTHING;
```

### React Component
```typescript
// src/features/system-admin/components/feature-flags/FeatureFlagsCard.tsx
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/lib/supabase/client';
import { Switch } from '@/components/ui/switch';

export const FeatureFlagsCard = () => {
  const { data: flags, isLoading } = useQuery({
    queryKey: ['feature-flags'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('feature_flags')
        .select('*')
        .order('name');
      
      if (error) throw error;
      return data;
    },
  });
  
  const toggleFlag = async (id: string, enabled: boolean) => {
    await supabase
      .from('feature_flags')
      .update({ enabled, updated_at: new Date().toISOString() })
      .eq('id', id);
    
    // Invalidate cache
    queryClient.invalidateQueries(['feature-flags']);
  };
  
  return (
    <Card>
      <CardHeader>
        <CardTitle>Feature Flags</CardTitle>
        <CardDescription>
          Control which features are available to organizations
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {flags?.map((flag) => (
            <div key={flag.id} className="flex items-center justify-between">
              <div className="flex-1">
                <h4 className="font-medium">{flag.name}</h4>
                <p className="text-sm text-gray-500">{flag.description}</p>
              </div>
              <Switch
                checked={flag.enabled}
                onCheckedChange={(enabled) => toggleFlag(flag.id, enabled)}
              />
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
};
```

---

## ğŸ”„ Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SYSTEM ADMIN CREATES ORG                     â”‚
â”‚                                                                 â”‚
â”‚  1. Fill form: name, owner_name, owner_email, plan             â”‚
â”‚  2. Submit â†’ OrganizationService.create()                      â”‚
â”‚  3. Supabase: INSERT INTO organizations (UUID auto-gen)        â”‚
â”‚  4. Stripe: Create customer with metadata                      â”‚
â”‚  5. Update: organizations.stripe_customer_id                   â”‚
â”‚  6. Return: Complete organization with auto-generated ID       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OWNER CREATES VENUE                          â”‚
â”‚                                                                 â”‚
â”‚  1. Select organization (from context)                          â”‚
â”‚  2. Fill form: name, address, email, phone                      â”‚
â”‚  3. Submit â†’ VenueService.create()                             â”‚
â”‚  4. Supabase: INSERT INTO venues (UUID auto-gen)               â”‚
â”‚     - organization_id: FK to organizations                     â”‚
â”‚  5. Trigger: update_organization_venue_count()                 â”‚
â”‚  6. Real-time: Broadcast to System Admin                       â”‚
â”‚  7. System Admin: Refetch org metrics (venue count +1)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OWNER CREATES GAME                           â”‚
â”‚                                                                 â”‚
â”‚  1. Select venue (from dropdown)                                â”‚
â”‚  2. Fill form: name, difficulty, price, etc.                    â”‚
â”‚  3. Submit â†’ GameService.create()                              â”‚
â”‚  4. Stripe: Create product + price                             â”‚
â”‚  5. Supabase: INSERT INTO games (UUID auto-gen)                â”‚
â”‚     - venue_id: FK to venues                                   â”‚
â”‚     - organization_id: FK to organizations                     â”‚
â”‚     - stripe_product_id, stripe_price_id                       â”‚
â”‚  6. Trigger: update_venue_game_count()                         â”‚
â”‚  7. Trigger: update_organization_game_count()                  â”‚
â”‚  8. Real-time: Broadcast to System Admin                       â”‚
â”‚  9. System Admin: Refetch org metrics (game count +1)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SYSTEM ADMIN DASHBOARD VIEW                    â”‚
â”‚                                                                 â”‚
â”‚  Organizations Table:                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Org ID  â”‚ Name   â”‚ Venues â”‚ Venue IDs    â”‚ Games        â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ uuid-1  â”‚ Org A  â”‚   3    â”‚ uuid-v1,     â”‚ uuid-g1,     â”‚  â”‚
â”‚  â”‚         â”‚        â”‚        â”‚ uuid-v2,     â”‚ uuid-g2,     â”‚  â”‚
â”‚  â”‚         â”‚        â”‚        â”‚ uuid-v3      â”‚ uuid-g3, +5  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â€¢ Real-time updates via Supabase subscriptions                 â”‚
â”‚  â€¢ Metrics recalculated on every change                         â”‚
â”‚  â€¢ IDs fetched from get_organization_metrics() RPC             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Implementation Steps

### Phase 1: Database Functions (Priority: HIGH)
- [ ] Create/update `get_organization_metrics()` RPC to include venue_ids, game_ids arrays
- [ ] Create trigger `update_organization_venue_count()` for real-time sync
- [ ] Create trigger `update_organization_game_count()` for real-time sync
- [ ] Add feature_flags table and seed data

**File:** `supabase/migrations/029_system_admin_real_data_architecture.sql`

### Phase 2: Organization Service (Priority: HIGH)
- [ ] Update `OrganizationService.create()` to integrate Stripe customer creation
- [ ] Add `createOrganizationMember()` to assign initial owner role
- [ ] Ensure organization_id is auto-generated (UUID v4)

**File:** `src/features/system-admin/services/OrganizationService.ts`

### Phase 3: Venue Service (Priority: HIGH)
- [ ] Ensure `VenueService.create()` auto-generates venue_id
- [ ] Add organization_id as required field
- [ ] Remove venue_id from create form validation

**Files:** 
- `src/services/VenueService.ts`
- `src/components/venues/VenueForm.tsx`

### Phase 4: Game Service (Priority: HIGH)
- [ ] Update `GameService.create()` to create Stripe product/price
- [ ] Ensure game_id is auto-generated
- [ ] Store stripe_product_id and stripe_price_id
- [ ] Add venue_id and organization_id as required fields

**Files:**
- `src/services/GameService.ts`
- `src/components/games/GameForm.tsx`

### Phase 5: Real-time Sync (Priority: MEDIUM)
- [ ] Add Supabase real-time subscriptions in `useOrganizations` hook
- [ ] Invalidate React Query cache on venue/game changes
- [ ] Implement optimistic UI updates

**File:** `src/features/system-admin/hooks/useOrganizations.ts`

### Phase 6: System Admin Display (Priority: MEDIUM)
- [ ] Update metrics display to show real venue_ids and game_ids
- [ ] Add tooltips for truncated ID lists
- [ ] Implement click-to-copy for IDs

**File:** `src/pages/SystemAdminDashboard.tsx`

### Phase 7: Feature Flags (Priority: LOW)
- [ ] Create FeatureFlagsCard component
- [ ] Add to System Admin dashboard
- [ ] Implement toggle functionality
- [ ] Seed with admin access features

**Files:**
- `src/features/system-admin/components/feature-flags/FeatureFlagsCard.tsx`
- `src/pages/SystemAdminDashboard.tsx`

---

## ğŸ”’ Security Considerations

### Row-Level Security (RLS)
```sql
-- Organizations: Only system admins can view all
CREATE POLICY "System admins can view all organizations"
ON organizations FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM auth.users
    WHERE id = auth.uid()
    AND raw_user_meta_data->>'role' = 'system_admin'
  )
);

-- Venues: Owners can view their own
CREATE POLICY "Owners can view their venues"
ON venues FOR SELECT
TO authenticated
USING (
  organization_id IN (
    SELECT organization_id FROM organization_members
    WHERE user_id = auth.uid()
  )
);

-- Games: Owners can view their own
CREATE POLICY "Owners can view their games"
ON games FOR SELECT
TO authenticated
USING (
  organization_id IN (
    SELECT organization_id FROM organization_members
    WHERE user_id = auth.uid()
  )
);
```

### API Permissions
- **System Admin** â†’ Full CRUD on all organizations
- **Organization Owner** â†’ Full CRUD on own organization's venues/games
- **Organization Admin** â†’ Read + Update on own organization
- **Staff** â†’ Read-only on assigned venues/games

---

## ğŸ“ˆ Success Metrics

### Technical Metrics
- âœ… **Organization ID auto-generation**: 100% success rate
- âœ… **Venue ID sync time**: < 5 seconds from creation to System Admin display
- âœ… **Game ID sync time**: < 5 seconds from creation to System Admin display
- âœ… **Stripe customer creation**: 100% success rate
- âœ… **Real-time subscription reliability**: 99.9% uptime

### User Experience Metrics
- âœ… **Form validation**: No errors on empty venue/game ID fields
- âœ… **Dashboard accuracy**: 100% match between DB and UI
- âœ… **Feature flag toggle**: < 1 second response time
- âœ… **Metrics refresh**: < 2 seconds after entity creation

---

## ğŸ¯ Next Steps

1. **Review this plan** with the team
2. **Create migration file** `029_system_admin_real_data_architecture.sql`
3. **Implement Phase 1** (Database functions and triggers)
4. **Test organization creation** with Stripe integration
5. **Implement real-time sync** and verify in System Admin dashboard
6. **Deploy to staging** and perform end-to-end testing

---

## ğŸ“š References

- [Supabase Real-time Documentation](https://supabase.com/docs/guides/realtime)
- [Stripe Customer API](https://stripe.com/docs/api/customers)
- [PostgreSQL UUID Functions](https://www.postgresql.org/docs/current/uuid-ossp.html)
- [Multi-tenant SaaS Architecture Patterns](https://aws.amazon.com/blogs/apn/saas-architecture-patterns/)

---

**Document Status:** âœ… Ready for Implementation  
**Last Updated:** November 17, 2025  
**Reviewed By:** System Architect
